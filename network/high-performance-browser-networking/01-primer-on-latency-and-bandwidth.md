# 1장: 레이턴시와 대역폭 이해의 첫걸음

## 속도는 하나의 특징이다

빠른 속도를 내기 위해서는 여러 가지 요소와 근본적인 제약사항에 대해 이해해야 한다.

* 레이턴시: 패킷을 전송하는 곳에서부터 전달받는 곳까지 이동하는 데 걸리는 시간
* 대역폭: 논리적인 혹은 물리적인 통신 경로의 최대 처리량

## 레이턴시의 구성 요소

인터넷 환경의 라우터에서 클라이언트와 서버 간 메시지를 주고받을 때 레이턴스를 일으키는 요소들은 다음과 같다.

* 전파 지연(Propagation delay): 메시지가 송신측(Sender)에서 수신측(Receiver)으로 이동하는데 필요한 시간. 총 이동거리 대비 신호가 이동하는 속도로 측정된다.
* 전송 지연(Transmission delay): 링크로 패킷의 모든 비트를 내보내는 데 필요한 시간. 패킷의 길이 대비 링크의 데이터 전송 속도로 측정된다.
* 프로세싱 지연(Processing delay): 패킷 헤더를 처리하고 비트 수준(bit-level)의 에러를 체크하고 패킷의 목적지를 알아내는 데 필요한 시간.
* 큐잉 지연(Queuing delay): 패킷이 처리될 때까지 큐(queue)에서 대기하는 시간.

위에 기술된 4가지 지연을 합친 것이 클라이언트와 서버 간의 총 레이턴시다.

## 빛의 속도와 전파 지연

빛의 속도는 모든 에너지와 물질 그리고 정보가 이동할 수 있는 최고 속도로서, 모든 네트워크 패킷의 전파 시간을 엄격히 제한하고 있다.

다행히 빛의 속도는 매우 빠르다. 초당 299,792,458미터에 이른다. 하지만 이것은 진공 상태였을 때의 속도이고, 보통 패킷을 보낼 때 사용하는 매체는 구리선이나 광섬유 케이블이기 때문에 그만큼 신호의 속도는 느려지게 된다. 빛의 속도 대비 특정 물질 안에서 패킷이 이동하는 속도를 측정한 것을 물질의 굴절률(refractive index)이라 한다. 이 값이 클수록 해당 물질 안에서 빛이 이동하는 속도는 감소한다.

> Content delivery network(CDN) 서비스는 많은 이점이 있지만 그 중에 가장 대표적인 것은 모든 데이터 패킷의 전파 시간을 대폭 줄일 수 있다는 점이다. 다시 말해, CDN이 지구 곳곳으로 콘텐츠를 배분하여 클라이언트와 가장 가까운 지점에서 전달받도록 하는 것이다.
>
> 우리는 패킷을 한 번에 더 빠르게 이동하게 할 수는 없을지라도 사용자와 가까운 곳에 서버를 위치시킴으로써 이동 거리를 줄일 수 있다. CDN을 잘 활용하면 데이터 전달 성능을 크게 향상시킬 수 있다.

## 최종 마일 레이턴시(Last-Mile Latency)

얄궃게도 대부분의 레이턴시가 발생하는 곳은 마지막 몇 킬로미터 지점이다. 집이나 사무실을 인터넷에 연결하기 위해서는 ISP가 각 지역에 케이블을 설치하고 신호를 취합하여 로컬 라우팅 노드로 넘겨주어야 한다. 네트워크의 연결방식, 라우팅 방법, 사용되는 기술 등에 의해 ISP의 메인 라우터에 도달하는 데에만 수십 밀리초가 걸릴 수도 있다.

현재 본인이 사용하고 있는 인터넷 제공업체의 토폴로지와 성능에 대해 자세히 알고 싶다면 `traceroute`라는 간단한 명령어로도 많은 정보를 얻을 수 있다.

```bash
traceroute google.com
```

최종 마일 레이턴시는 당신이 사용하는 인터넷 제공업체, 사용되는 기술, 네트워크의 토폴로지, 심지어는 하루의 시간대에 따라서도 바뀔 수 있다. 인터넷 사용자로서 웹 브라우징의 속도를 높이고 싶다면 ISP를 선택할 때 레이턴시를 낮추는 데 중점을 두는 것이 좋다.

> 대부분의 웹사이트들에서 성능의 병목점은 대역폭이 아니라 레이턴시다.

> Traceroute는 IP 네트워크에서 발생하는 홉의 레이턴시와 패킷의 이동경로를 파악할 수 있는 간단한 네트워크 진단 도구다. Traceroute는 각 홉을 구분하기 위해서 '홉 한도'(1, 2, 3 등등)을 정해 일련의 패킷을 도착지점으로 보낸다. 패킷이 홉 한꼐에 다다르면 중계지점에서 ICMP 시간 초과 메시지를 보내옴으로써 각 네트워크 홉마다 발생하는 레이턴시를 측정할 수 있게 한다.

## 코어 네트워크(Core Networks)의 대역폭

광섬유는 파장 분할 다중화(wavelength-division multiplexing, WDM)을 통해 각 섬유마다 다른 파장의 빛을 이동시킬 수 있으므로 대역폭에 있어서는 확실한 이점을 가지고 있다. 그러므로 광섬유 링크의 총 대역폭은 다중 송신되는 채널의 수에 채널별 데이터 전송률을 곱한 만큼의 값이다.

201년 초에 연구진들은 광섬유 링크를 이용하여 채널당 최대 171Gbit/s로 400개 이상의 채널을 다중화 할 수 잇게 되었다. 하나의 광섬유 링크당 70Tbit/s의 대역폭을 갖게 되는 것이다. 각 케이블은 몇 가닥의 섬유(보통 4가닥으로 이루어져 있음)로 구성되어 있는데, 이는 각 케이블마다 초당 수백 테라 비트의 대역폭으로 해석할 수 있다.

##네트워크 가장자리(Network Edge)에서의 대역폭

인터넷의 핵심 데이터 패스를 구성하는 백본망 혹은 광섬유 링크는 초당 수백 테라 비트의 데이터를 옮길 수 있다. 하지만 네트워크의 끝자락에서는 사용하는 기술에 따라서 그 허용치는 훨씬 적다.

우리가 사용하는 데이터 네트워크는 본래 처리량과 레이턴시 성능이 일정치 못하다.

## 높은 대역폭과 낮은 레이턴시 제공

비용이 저렴하지는 않으나, 다행히도 대역폭의 허용치를 높일 수 있는 방법이 여러 가지 존재한다. 광섬유 링크에 섬유를 더 추가하는 방법도 있고, 정체된 루트에 링크를 더 설치하는 방법도 있다. WDM 기술을 더 보완하여 현재의 링크에 더 많은 데이터를 전달할 수 있게끔 하는 방법도 있다.

하지만 레이턴시를 낮추는 것은 전혀 다른 문제다. 굴절률을 낮추고 좀 더 빠른 라우터를 사용함으로써 광섬유 링크의 질을 높이면 빛의 속도에 좀 더 접근할 수는 있을 것이다. 하지만 현재 우리에게 주어진 속도가 빛의 속도의 -1.5 이내라는 것을 감안하면, 위에 말한 방법으로는 잘해봐야 30% 정도밖에는 속도 향상이 어렵다. 불행히도 우리는 물리 법칙을 거스를 수 없기에 레이턴시를 최소화시키는 것은 빛의 속도에 강하게 제한될 수 밖에 없다.

다르게 생각해보면, 우리는 빛의 속도보다 더 빨리 이동할 수는 없으므로 이동거리를 줄이는 방법을 택할 수 있다. 지구상의 두 지점 사이의 최단거리는 언제나 지구의 둥근 면을 따라 정의되지만, 지형적인 문제나 사회적, 정치적인 문제, 그리고 비용 문제 등 여러 가지 요인으로 인하여 최단거리에 새로운 케이블을 놓는 것이 항상 쉬운 일은 아니다.

결과적으로 우리는 주어진 대역폭과 빛의 속도라는 한계점을 분명하게 인식하여 프로토콜과 네트워킹 코드를 설계하고 최적화해야만 우리의 애플리케이션 성능을 향상시킬 수 있다. 왕복거리를 줄이고, 클라이언트와 가까운 곳에 데이터를 위치시키고, 레이턴시를 감추기 위해 캐싱, 프리페칭(pre-fetching) 등 외에도 다양한 기술들을 이용하여 애플리케이션을 구축해야 한다.

## QNA

- 레이턴시와 대역폭에 대한 구체적 이해 필요
- CDN: 전파 지연을 감소시켜주는 이점 외에 또 다른 이점은?
- ISP, FTTH, DSL
- 토폴로지
- 대부분의 웹사이트들에서 성능의 병목점은 대역폭이 아니라 레이턴시? 대역폭을 늘려도 큰 영향은 없다?
- 홉
- ICMP

## 참고 {docsify-ignore}

* [네트워킹과 웹 성능 최적화 기법 | 알리아 그리고릭, 인사이트](http://www.kyobobook.co.kr/product/detailViewKor.laf?mallGb=KOR&ejkGb=KOR&linkClass=3309&barcode=9788966261659)
